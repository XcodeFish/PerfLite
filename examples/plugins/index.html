<!DOCTYPE html>
<html lang="zh-cn">

<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>PerfLite - Reactæ€§èƒ½ç›‘æ§ç¤ºä¾‹</title>
  <script crossorigin src="https://unpkg.com/react@18/umd/react.development.js"></script>
  <script crossorigin src="https://unpkg.com/react-dom@18/umd/react-dom.development.js"></script>
  <script crossorigin src="https://unpkg.com/babel-standalone@6/babel.min.js"></script>
  <script src="../../dist/perflite.js"></script>
  <style>
    body {
      font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen, Ubuntu, Cantarell, 'Open Sans', 'Helvetica Neue', sans-serif;
      margin: 0;
      padding: 20px;
      background-color: #f5f5f5;
    }

    .container {
      max-width: 1200px;
      margin: 0 auto;
      padding: 20px;
      background-color: #fff;
      border-radius: 8px;
      box-shadow: 0 2px 8px rgba(0, 0, 0, 0.1);
    }

    .panel {
      margin-bottom: 20px;
      border: 1px solid #eee;
      border-radius: 4px;
      padding: 15px;
    }

    .panel-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      border-bottom: 1px solid #eee;
      padding-bottom: 10px;
      margin-bottom: 15px;
    }

    .btn {
      background-color: #4c6ef5;
      color: white;
      border: none;
      padding: 8px 15px;
      border-radius: 4px;
      cursor: pointer;
      font-size: 14px;
    }

    .btn:hover {
      background-color: #3b5bdb;
    }

    .btn-secondary {
      background-color: #868e96;
    }

    .btn-secondary:hover {
      background-color: #495057;
    }

    .table {
      width: 100%;
      border-collapse: collapse;
      margin-bottom: 1rem;
    }

    .table th,
    .table td {
      padding: 0.75rem;
      text-align: left;
      border-bottom: 1px solid #dee2e6;
    }

    .table th {
      background-color: #f8f9fa;
    }

    .status {
      padding: 6px 10px;
      border-radius: 4px;
      font-size: 12px;
      font-weight: 500;
    }

    .status-high {
      background-color: #fa5252;
      color: white;
    }

    .status-medium {
      background-color: #ff922b;
      color: white;
    }

    .status-low {
      background-color: #20c997;
      color: white;
    }

    .counter {
      background-color: #e9ecef;
      padding: 2px 6px;
      border-radius: 4px;
      font-size: 12px;
      font-weight: bold;
    }

    .todo-app {
      border: 1px solid #dee2e6;
      border-radius: 4px;
      padding: 20px;
      margin-top: 20px;
    }

    .todo-header {
      display: flex;
      margin-bottom: 15px;
    }

    .todo-input {
      flex: 1;
      padding: 8px 12px;
      border: 1px solid #ced4da;
      border-radius: 4px 0 0 4px;
      font-size: 16px;
    }

    .todo-add-btn {
      border: none;
      background-color: #4c6ef5;
      color: white;
      padding: 8px 15px;
      border-radius: 0 4px 4px 0;
      font-size: 16px;
      cursor: pointer;
    }

    .todo-list {
      list-style-type: none;
      padding: 0;
      margin: 0;
    }

    .todo-item {
      display: flex;
      align-items: center;
      padding: 10px 0;
      border-bottom: 1px solid #eee;
    }

    .todo-text {
      flex: 1;
      margin-left: 10px;
    }

    .todo-delete {
      color: #ff6b6b;
      cursor: pointer;
      background: none;
      border: none;
      font-size: 16px;
    }

    .filter-buttons {
      display: flex;
      margin-top: 15px;
      gap: 10px;
    }

    .filter-btn {
      background-color: #e9ecef;
      border: none;
      padding: 8px 15px;
      border-radius: 4px;
      cursor: pointer;
    }

    .filter-btn.active {
      background-color: #4c6ef5;
      color: white;
    }

    .error {
      color: #e03131;
      margin-top: 10px;
      font-size: 14px;
    }
  </style>
</head>

<body>
  <div class="container">
    <h1>PerfLite - Reactæ€§èƒ½ç›‘æ§ç¤ºä¾‹</h1>

    <div class="panel">
      <div class="panel-header">
        <h2>Reactæ’ä»¶çŠ¶æ€</h2>
        <div>
          <button id="refresh-btn" class="btn">åˆ·æ–°æ€§èƒ½æ•°æ®</button>
          <button id="reset-btn" class="btn btn-secondary">é‡ç½®æ•°æ®</button>
        </div>
      </div>
      <div id="react-info"></div>
    </div>

    <div class="panel">
      <h2>æ€§èƒ½é—®é¢˜</h2>
      <div id="performance-issues">
        <p>ç­‰å¾…æ”¶é›†æ€§èƒ½æ•°æ®...</p>
      </div>
    </div>

    <div class="panel">
      <h2>ç»„ä»¶æ¸²æŸ“ç»Ÿè®¡</h2>
      <div class="tabs">
        <button class="tab active" data-tab="slow">æ¸²æŸ“æœ€æ…¢çš„ç»„ä»¶</button>
        <button class="tab" data-tab="renders">é‡æ¸²æŸ“æœ€å¤šçš„ç»„ä»¶</button>
      </div>

      <div class="tab-content" id="tab-slow">
        <table class="table">
          <thead>
            <tr>
              <th>ç»„ä»¶åç§°</th>
              <th>å¹³å‡æ¸²æŸ“æ—¶é—´ (ms)</th>
              <th>æ¸²æŸ“æ¬¡æ•°</th>
            </tr>
          </thead>
          <tbody id="slow-components"></tbody>
        </table>
      </div>

      <div class="tab-content" id="tab-renders" style="display: none;">
        <table class="table">
          <thead>
            <tr>
              <th>ç»„ä»¶åç§°</th>
              <th>æ¸²æŸ“æ¬¡æ•°</th>
            </tr>
          </thead>
          <tbody id="render-count-components"></tbody>
        </table>
      </div>
    </div>

    <div id="react-app"></div>
  </div>

  <script type="text/babel">
    // åˆå§‹åŒ–PerfLite
    const perfLite = PerfLite.init({
      appId: 'react-performance-demo',
      deepseek: {
        enable: false
      }
    })

    // æœ‰é—®é¢˜çš„TodoAppå®ç°ï¼Œä¼šå¯¼è‡´æ€§èƒ½é—®é¢˜
    const TodoApp = () =>
    {
      const [todos, setTodos] = React.useState([])
      const [inputValue, setInputValue] = React.useState('')
      const [filter, setFilter] = React.useState('all')
      const [count, setCount] = React.useState(0)

      // é—®é¢˜1: ä¸å¿…è¦çš„çŠ¶æ€æ›´æ–°
      React.useEffect(() =>
      {
        const interval = setInterval(() =>
        {
          setCount(c => c + 1)
        }, 100) // é«˜é¢‘æ›´æ–°

        return () => clearInterval(interval)
      }, [])

      // é—®é¢˜2: ä¸å¿…è¦çš„é‡æ–°è®¡ç®—
      const filteredTodos = React.useMemo(() =>
      {
        switch (filter) {
          case 'completed':
            return todos.filter(todo => todo.completed)
          case 'active':
            return todos.filter(todo => !todo.completed)
          default:
            return todos
        }
      }, [todos, filter])

      const handleAdd = () =>
      {
        if (inputValue.trim()) {
          setTodos([...todos, {
            id: Date.now(),
            text: inputValue,
            completed: false
          }])
          setInputValue('')
        }
      }

      const handleToggle = (id) =>
      {
        setTodos(todos.map(todo =>
          todo.id === id ? { ...todo, completed: !todo.completed } : todo
        ))
      }

      const handleDelete = (id) =>
      {
        setTodos(todos.filter(todo => todo.id !== id))
      }

      const handleKeyPress = (e) =>
      {
        if (e.key === 'Enter') {
          handleAdd()
        }
      }

      return (
        <div className="todo-app">
          <h2>React TodoMVC {count % 10 === 0 ? 'ğŸš€' : ''}</h2>

          <div className="todo-header">
            <input
              className="todo-input"
              type="text"
              placeholder="æ·»åŠ æ–°ä»»åŠ¡..."
              value={inputValue}
              onChange={(e) => setInputValue(e.target.value)}
              onKeyPress={handleKeyPress}
            />
            <button className="todo-add-btn" onClick={handleAdd}>æ·»åŠ </button>
          </div>

          {/* é—®é¢˜3: ç¼ºå°‘React.memo */}
          <TodoList
            todos={filteredTodos}
            onToggle={handleToggle}
            onDelete={handleDelete}
          />

          <div className="filter-buttons">
            <button
              className={`filter-btn ${filter === 'all' ? 'active' : ''}`}
              onClick={() => setFilter('all')}
            >
              å…¨éƒ¨
            </button>
            <button
              className={`filter-btn ${filter === 'active' ? 'active' : ''}`}
              onClick={() => setFilter('active')}
            >
              æœªå®Œæˆ
            </button>
            <button
              className={`filter-btn ${filter === 'completed' ? 'active' : ''}`}
              onClick={() => setFilter('completed')}
            >
              å·²å®Œæˆ
            </button>
          </div>
        </div>
      )
    }

    // é—®é¢˜4: å­ç»„ä»¶æ²¡æœ‰ä½¿ç”¨memo
    const TodoList = ({ todos, onToggle, onDelete }) =>
    {
      // é—®é¢˜5: ä¸å¿…è¦çš„é‡æ–°è®¡ç®—
      const completedCount = todos.filter(todo => todo.completed).length

      return (
        <>
          <ul className="todo-list">
            {todos.map(todo => (
              <TodoItem
                key={todo.id}
                todo={todo}
                onToggle={onToggle}
                onDelete={onDelete}
              />
            ))}
          </ul>
          <div>
            <p>å·²å®Œæˆ: {completedCount} / {todos.length}</p>
          </div>
        </>
      )
    }

    // é—®é¢˜6: å­ç»„ä»¶æ²¡æœ‰ä½¿ç”¨memo
    const TodoItem = ({ todo, onToggle, onDelete }) =>
    {
      // é—®é¢˜7: ä¸å¿…è¦çš„State
      const [showDelete, setShowDelete] = React.useState(false)

      return (
        <li
          className="todo-item"
          onMouseEnter={() => setShowDelete(true)}
          onMouseLeave={() => setShowDelete(false)}
        >
          <input
            type="checkbox"
            checked={todo.completed}
            onChange={() => onToggle(todo.id)}
          />
          <span
            className="todo-text"
            style={{ textDecoration: todo.completed ? 'line-through' : 'none' }}
          >
            {todo.text}
          </span>
          {showDelete && (
            <button
              className="todo-delete"
              onClick={() => onDelete(todo.id)}
            >
              âœ•
            </button>
          )}
        </li>
      )
    }

    // æ¸²æŸ“Reactåº”ç”¨
    const root = ReactDOM.createRoot(document.getElementById('react-app'))
    root.render(<TodoApp />)

    // æ›´æ–°æ€§èƒ½ä¿¡æ¯æ˜¾ç¤º
    function updatePerformanceInfo ()
    {
      const reactApi = perfLite.getPlugin('react-profiler')?.api

      if (reactApi) {
        // æ›´æ–°Reactä¿¡æ¯
        const reactInfo = document.getElementById('react-info')
        reactInfo.innerHTML = `
          <p>Reactç‰ˆæœ¬: <strong>${reactApi.reactVersion}</strong></p>
          <p>Concurrent Mode: <strong>${reactApi.isConcurrentMode ? 'å¯ç”¨' : 'æœªå¯ç”¨'}</strong></p>
          <p>ProfilerçŠ¶æ€: <strong>${reactApi.isProfilerEnabled ? 'æ¿€æ´»' : 'æœªæ¿€æ´»'}</strong></p>
          <p>ç›‘æ§ç»„ä»¶æ•°: <strong>${reactApi.getPerformanceInfo()?.totalComponents || 0}</strong></p>
        `

        // æ›´æ–°æ€§èƒ½é—®é¢˜åˆ—è¡¨
        const issues = reactApi.getPerformanceInfo()?.performanceIssues || []
        const issuesContainer = document.getElementById('performance-issues')

        if (issues.length === 0) {
          issuesContainer.innerHTML = '<p>æš‚æœªæ£€æµ‹åˆ°æ€§èƒ½é—®é¢˜ã€‚</p>'
        } else {
          let html = `
            <table class="table">
              <thead>
                <tr>
                  <th>ç»„ä»¶åç§°</th>
                  <th>é—®é¢˜ç±»å‹</th>
                  <th>ä¸¥é‡ç¨‹åº¦</th>
                  <th>è®¡æ•°</th>
                  <th>å»ºè®®</th>
                </tr>
              </thead>
              <tbody>
          `

          issues.forEach(issue =>
          {
            const problemTypes = {
              'excessive-renders': 'è¿‡å¤šæ¸²æŸ“',
              'slow-render': 'æ¸²æŸ“ç¼“æ…¢',
              'cascading-updates': 'çº§è”æ›´æ–°',
              'high-memory': 'å†…å­˜å ç”¨é«˜',
              'state-thrashing': 'çŠ¶æ€é¢‘ç¹æ›´æ–°'
            }

            html += `
              <tr>
                <td><strong>${issue.componentName}</strong></td>
                <td>${problemTypes[issue.type] || issue.type}</td>
                <td><span class="status status-${issue.severity}">${issue.severity === 'high' ? 'é«˜' : issue.severity === 'medium' ? 'ä¸­' : 'ä½'}</span></td>
                <td><span class="counter">${issue.count}</span></td>
                <td>${issue.suggestion}</td>
              </tr>
            `
          })

          html += '</tbody></table>'
          issuesContainer.innerHTML = html
        }

        // æ›´æ–°æ…¢ç»„ä»¶è¡¨æ ¼
        const slowComponents = reactApi.getPerformanceInfo()?.topSlowComponents || []
        const slowTable = document.getElementById('slow-components')

        slowTable.innerHTML = ''
        slowComponents.forEach(comp =>
        {
          const row = document.createElement('tr')
          row.innerHTML = `
            <td>${comp.name}</td>
            <td>${comp.avgDuration.toFixed(2)}</td>
            <td>${comp.renderCount}</td>
          `
          slowTable.appendChild(row)
        })

        // æ›´æ–°æ¸²æŸ“æ¬¡æ•°è¡¨æ ¼
        const renderCountComponents = reactApi.getPerformanceInfo()?.mostReRenderedComponents || []
        const renderCountTable = document.getElementById('render-count-components')

        renderCountTable.innerHTML = ''
        renderCountComponents.forEach(comp =>
        {
          const row = document.createElement('tr')
          row.innerHTML = `
            <td>${comp.name}</td>
            <td>${comp.renderCount}</td>
          `
          renderCountTable.appendChild(row)
        })
      }
    }

    // 5ç§’åæ›´æ–°æ€§èƒ½ä¿¡æ¯ï¼Œå¹¶ä¹‹åå®šæœŸæ›´æ–°
    setTimeout(() =>
    {
      updatePerformanceInfo()
      setInterval(updatePerformanceInfo, 3000)
    }, 5000)

    // åˆ·æ–°æŒ‰é’®ç‚¹å‡»äº‹ä»¶
    document.getElementById('refresh-btn').addEventListener('click', updatePerformanceInfo)

    // é‡ç½®æŒ‰é’®ç‚¹å‡»äº‹ä»¶
    document.getElementById('reset-btn').addEventListener('click', () =>
    {
      const reactApi = perfLite.getPlugin('react-profiler')?.api
      if (reactApi) {
        reactApi.resetData()
        updatePerformanceInfo()
      }
    })

    // æ ‡ç­¾åˆ‡æ¢
    document.querySelectorAll('.tab').forEach(tab =>
    {
      tab.addEventListener('click', () =>
      {
        // æ›´æ–°æ´»åŠ¨æ ‡ç­¾
        document.querySelector('.tab.active').classList.remove('active')
        tab.classList.add('active')

        // åˆ‡æ¢å†…å®¹æ˜¾ç¤º
        const tabId = tab.dataset.tab
        document.querySelectorAll('.tab-content').forEach(content =>
        {
          content.style.display = 'none'
        })
        document.getElementById(`tab-${tabId}`).style.display = 'block'
      })
    });
  </script>
</body>

</html>